# Source: https://docs.getdbt.com/blog/sql-surrogate-keys

Generating Surrogate Keys Across Warehouses | dbt Developer Blog

[Skip to main content](#__docusaurus_skipToContent_fallback)

[✨ Live virtual event - Smarter pipelines, 29% more efficient: How the dbt Fusion engine optimizes data work on December 3rd!](https://www.getdbt.com/resources/webinars/how-the-dbt-fusion-engine-optimizes-data-work)

[![dbt Logo](/img/dbt-logo.svg?v=2)](/)

[Docs](#)

* [Product docs](/docs/introduction)
* [References](/reference/references-overview)
* [Best practices](/best-practices)
* [Developer blog](/blog)

[Guides](/guides)[APIs](/docs/dbt-cloud-apis/overview)

[Help](#)

* [Release notes](/docs/dbt-versions/dbt-cloud-release-notes)
* [FAQs](/docs/faqs)
* [Support and billing](/docs/dbt-support)
* [Fusion Diaries](https://github.com/dbt-labs/dbt-fusion/discussions/categories/announcements)
* [Courses](https://learn.getdbt.com)

[Community](#)

* [Join the dbt Community](/community/join)
* [Become a contributor](/community/contribute)
* [Community forum](/community/forum)
* [Events](/community/events)
* [Spotlight](/community/spotlight)

[Account](#)

* [Log in to dbt](https://cloud.getdbt.com/)
* [Create a free account](https://www.getdbt.com/signup)

[Install VS Code extension](https://marketplace.visualstudio.com/items?itemName=dbtLabsInc.dbt)

[dbt platform (Latest)](#)

* dbt platform (Latest)
* dbt Fusion engine
* Core v1.11 Beta
* Core v1.10 (Compatible)
* Core v1.9 (Extended)

Search`⌘``K`

[dbt Docs](/ "dbt Docs")[Developer Blog](/blog "Blog")[Generating Surrogate Keys Across Warehouses](# "Generating Surrogate Keys Across Warehouses")

On this page

Generating Surrogate Keys Across Warehouses
===========================================

November 29, 2021 · 7 min read

[![Sanjana Sen](/img/blog/authors/sanjana.png)](/blog/authors/sanjana-sen)

[Sanjana Sen](/blog/authors/sanjana-sen)

Analytics Engineer at dbt Labs

[![Jason Ganz](/img/blog/authors/jasnonaz.jpeg)](/blog/authors/jason-ganz)

[Jason Ganz](/blog/authors/jason-ganz)

Developer Experience at dbt Labs

[![David Krevitt](/img/blog/authors/dkrevitt.jpg)](/blog/authors/david-krevitt)

[David Krevitt](/blog/authors/david-krevitt)

Marketing at dbt Labs

### Why primary keys are important[​](#why-primary-keys-are-important "Direct link to Why primary keys are important")

We all know one of the most fundamental rules in data is that every tableIn simplest terms, a table is the direct storage of data in rows and columns. Think excel sheet with raw values in each of the cells. should have a primary keyA primary key is a non-null column in a database object that uniquely identifies each row.. Primary keys are critical for many reasons:

* They ensure that you don’t have duplicate rows in your table
* They help establish relationships to other tables
* They allow you to quickly identify the grainYour data's grain is the combination of columns at which records in a table are unique. Ideally, this is captured in a single column and a unique primary key. of the table (ex: the `customers` table with a PK of `customer_id` has one row per customer)
* You can test them in dbt, to ensure that your data is complete and unique

If you are lucky, your data will come to you with a unique primary key already in place. Maybe it is an `id` generated by your internal product systems, or maybe you are pulling data in from a third party source that generates the id for you.

Sometimes, however, you find yourself in a situation where you don’t have a tidy [primary key](/blog/primary-key-testing).

For example, maybe you have joined your users to the set of features that they use in your product, such that your data should be expected to be unique on the `user_id` + `product_id` basis.

The question is - in this situation, how are you supposed to set a primary key? Meet the *surrogate key*.

### What’s a surrogate key?[​](#whats-a-surrogate-key "Direct link to What’s a surrogate key?")

A surrogate keyA surrogate key is a unique identifier derived from the data itself. It often takes the form of a hashed value of multiple columns that will create a uniqueness constraint for each row. is a primary key that, instead of existing in your underlying dataset, is *derived in the analytics layer itself.*

Learning when to use surrogate keys and bring them into your project is a critical skill for any analytics professional.

Knowing when to use a surrogate key is actually quite easy: you should have a surrogate key on any table that doesn’t already have a unique primary key.

Knowing *how* to create a surrogate key can prove to be much more challenging. The reason for this is that it isn’t always easy to know the best way to implement surrogate keys. Should you just be blocking off time on your calendar every day to individually name each of your rows?

Turns out this is a relatively well-solved problem. To create a surrogate key, you traditionally follow these two steps.

1. Concatenate together all of the fields required to make a unique row (for example, `user_id` and `product_id`)
2. Apply a function to create a cryptographic hash (usually using the [md5 function](https://blog.getdbt.com/the-most-underutilized-function-in-sql/)) on top of these to generate a unique id per combination of unique values

While the process of creating a surrogate key is relatively well understood, you will be shocked (SHOCKED I SAY) to hear that SQL syntax can have subtle differences across dialects and databases.

#### Surrogate keys in BigQuery, Databricks, Redshift and Snowflake[​](#surrogate-keys-in-bigquery-databricks-redshift-and-snowflake "Direct link to Surrogate keys in BigQuery, Databricks, Redshift and Snowflake")

[BigQuery](https://cloud.google.com/bigquery/docs/reference/standard-sql/string_functions#concat), [Redshift](https://docs.aws.amazon.com/redshift/latest/dg/r_CONCAT.html) and [Snowflake’s](https://docs.snowflake.com/en/sql-reference/functions/concat.html) concat functions returns null if any of the referenced columns for that row returns a null, so to create a proper surrogate key you’d need to wrap each column in a `coalesce` before hashing with an md5 function:

```
md5 ( concat ( coalesce(column1, '_this_used_to_be_null_'), coalesce(column2, '_this_used_to_be_null_') ) )
```

You'll notice that instead of coalescing to a blank string, there is a long replacement string. It doesn't matter what this string is, as long as it's consistent across your project and doesn't appear in any of your data. When you coalesce to a blank string, you can't differentiate between `null` and `''` which sometimes has semantic meaning. Compare the results of these surrogate keys:
![A table with two columns, comparing surrogate keys when nulls and blank strings are treated the same and differently.](/assets/images/surrogate_key_comparison-48a3a155b58a068efed9f495c2046a44.png)

[Databricks](https://docs.databricks.com/sql/language-manual/functions/concat.html)’ concat function docs don’t specifically reference returning null for the concat if one column is null, but I believe that’s what’s meant by `The result type matches the argument types`.

You could also separate your columns with pipes (`||`) rather than using the concat function, but I generally stay away from pipes (one comma > two pipes).

#### Surrogate keys in Postgres[​](#surrogate-keys-in-postgres "Direct link to Surrogate keys in Postgres")

Postgres’ `concat` function ignores nulls, which saves you from having to wrap each column in a `coalesce` function to default nulls to a different value (but this has the same drawback shown in the table above, where you can get the same key from different inputs).

If you used `||` instead of `concat`, one *null* column would cause the entire statement would return a null, breaking your concatenation.

So in plain old PostgreSQL, you’d use:

```
md5 ( concat (column1, column2) )
```

#### The null value problem in surrogate keys[​](#the-null-value-problem-in-surrogate-keys "Direct link to The null value problem in surrogate keys")

The primary annoyance when creating surrogate keys comes when you try and concatenate a row that has a null value for one or more columns. If any value is null, then often the entire concatenated string is returned as null - no good!

```
with   
  
example_ids as (  
  select  
  123 as user_id,  
  123 as product_id  
  
  union all  
  
  select  
  123 as user_id,  
  null as product_id  
  
  union all  
  
  select  
  null as user_id,  
  123 as product_id  
  
)  
  
select  
  *,  
  concat(user_id, product_id) as _surrogate_key  
from example_ids
```

output:

| USER\_ID | PRODUCT\_ID | \_SURROGATE\_KEY |
| --- | --- | --- |
| 123 | 123 | 123123 |
| 123 | `null` | `null` |
| `null` | 123 | `null` |

You can get around this by wrapping each of your columns in a `coalesce` function to default nulls to an alternate value, which is pretty tedious. You can also run into problems if the fields are different datatypes (string vs numeric), so sometimes you need to cast as well.

```
...  
select  
  *,  
  concat(  
    coalesce(cast(user_id as string), '_this_used_to_be_null_'),  
    coalesce(cast(product_id as string), '_this_used_to_be_null_')  
    ) as _surrogate_key  
from example_ids
```

output:

| USER\_ID | PRODUCT\_ID | \_SURROGATE\_KEY |
| --- | --- | --- |
| 123 | 123 | 123123 |
| 123 | `null` | 123\_this\_used\_to\_be\_null\_ |
| `null` | 123 | \_this\_used\_to\_be\_null\_123 |

Much better! But let's add another row to our dataset:

```
with   
  
example_ids as (  
  select  
  123 as user_id,  
  123 as product_id  
  
  union all  
  
  select  
  123 as user_id,  
  null as product_id  
  
  union all  
  
  select  
  null as user_id,  
  123 as product_id  
  
  union all   
    
  select 1231 as user_id,  
  23 as product_id  
  
)  
  
select  
  *,  
  concat(  
    coalesce(cast(user_id as string), '_this_used_to_be_null_'),  
    coalesce(cast(product_id as string), '_this_used_to_be_null_')  
    ) as _surrogate_key  
from example_ids
```

output:

| USER\_ID | PRODUCT\_ID | \_SURROGATE\_KEY |
| --- | --- | --- |
| 123 | 123 | 123123 |
| 123 | `null` | 123\_this\_used\_to\_be\_null\_ |
| `null` | 123 | \_this\_used\_to\_be\_null\_123 |
| 1231 | 23 | 123123 |

At first glance, this looks like it works, but in reality there are two identical keys: `123123`.

To remedy this, you need to add a separator between fields you wish to concatenate.

```
...  
select  
  *,  
  concat(  
    coalesce(cast(user_id as string), ''),  
    '|',  
    coalesce(cast(product_id as string), '')  
    ) as _surrogate_key  
from example_ids
```

output:

| USER\_ID | PRODUCT\_ID | \_SURROGATE\_KEY |
| --- | --- | --- |
| 123 | 123 | 123|123 |
| 123 | `null` | 123|\_this\_used\_to\_be\_null\_ |
| `null` | 123 | \_this\_used\_to\_be\_null\_|123 |
| 1231 | 23 | 1231|23 |

Let’s take a look at how generating surrogate keys specifically looks in practice across data warehousesA data warehouse is a data management system used for data storage and computing that allows for analytics activities such as transforming and sharing data., and how you can use one simple dbt macro ([dbt\_utils.generate\_surrogate\_key](https://github.com/dbt-labs/dbt-utils#surrogate_key-source)) to abstract away the null value problem.

### A surrogate\_key macro to the rescue[​](#a-surrogate_key-macro-to-the-rescue "Direct link to A surrogate_key macro to the rescue")

Thanks to a handy function called [generate\_surrogate\_key](https://github.com/dbt-labs/dbt-utils#generate_surrogate_key-source) in the [dbt\_utils package](https://hub.getdbt.com/dbt-labs/dbt_utils/latest/), you can fire yourself from the business of wrapping your columns in `coalesce` every time you want to generate a surrogate key.

Forming your surrogate keys with this macro has the benefit of **elegant + DRYDRY is a software development principle that stands for “Don’t Repeat Yourself.” Living by this principle means that your aim is to reduce repetitive patterns and duplicate code and logic in favor of modular and referenceable code. null handling**.

Rather than wrapping your columns in a `coalesce` function when concatenating them, the macro loops through your columns and *coalesces* on your behalf, so that you can avoid repeating yourself.

When you call `{{ dbt_utils.generate_surrogate_key(['field_a', 'field_b'[,...]]) }}`, behind the scenes dbt compiles SQL on your behalf, looping through each field and generating the correct number of `coalesce` statements with type casting:

```
  coalesce(cast(" ~ field ~ " as " ~ dbt.type_string() ~ "), '_dbt_utils_surrogate_key_null_')
```

and with conditional logic, adding separator between fields:

```
  {%- if not loop.last %}  
    {%- set _ = fields.append("'-'") -%}  
  {%- endif -%}
```

What does this mean in practice?

Well, you simply don’t have to think about your surrogate keys all that much. On any data warehouse, nulls or no nulls, it just works. Because honestly, who wants to spend more time than they need to thinking about surrogate keys?

**Tags:**

* [sql magic](/blog/tags/sql-magic)

#### Comments

* gwerbin-tive

  Is there a reason that compound/composite keys aren’t mentioned here? Should they be avoided when using dbt?
[Continue discussion](https://discourse.getdbt.com/t/6679 "Continue discussion")

[Newer post

What's a Primary Key and Why Do We Test Them?](/blog/primary-key-testing)[Older post

How to Upgrade dbt Versions (Mostly) Without Fear](/blog/upgrade-dbt-without-fear)

* [Why primary keys are important](#why-primary-keys-are-important)
* [What’s a surrogate key?](#whats-a-surrogate-key)
* [A surrogate\_key macro to the rescue](#a-surrogate_key-macro-to-the-rescue)

#### Live virtual event

Experience the dbt Fusion engine with Tristan Handy and Elias DeFaria on October 28th

[Save your seat](https://www.getdbt.com/resources/webinars/speed-simplicity-cost-savings-experience-the-dbt-fusion-engine "Save your seat")

Get started

Start building with dbt.
------------------------

The free dbt VS Code extension is the best way to develop locally with the dbt Fusion Engine.

[Install free extension](https://marketplace.visualstudio.com/items?itemName=dbtLabsInc.dbt)
[Request your demo](https://www.getdbt.com/contact)

[![dbt Labs](/img/dbt-logo-light.svg?v=2)](/)

##### Resources

[VS Code Extension](/docs/about-dbt-extension)
[Resource Hub](https://www.getdbt.com/resources)
[dbt Learn](https://www.getdbt.com/dbt-learn)
[Certification](https://www.getdbt.com/dbt-certification)
[Developer Blog](/blog)

##### Community

[Join the Community](/community/join)
[Become a Contributor](/community/contribute)
[Open Source dbt Packages](https://hub.getdbt.com/)
[Community Forum](/community/forum)

##### Support

[Contact Support](/docs/dbt-support)
[Professional Services](https://www.getdbt.com/services)
[Find a Partner](https://www.getdbt.com/partner-directory)
[System Status](https://status.getdbt.com/)

##### Connect with Us

© 2025 dbt Labs, Inc. All Rights Reserved.

[Terms of Service](https://www.getdbt.com/terms-of-use/)
[Privacy Policy](https://www.getdbt.com/cloud/privacy-policy/)
[Security](https://www.getdbt.com/security/)
Cookie Settings




![dbt Labs](https://cdn.cookielaw.org/logos/4a2cde9e-5f84-44b2-bdbb-6a93354d1c72/e1199e19-1935-49fa-a4e2-bf7f9d08cee6/783d7c83-af8c-4032-901b-b3ec48982078/dbt-logo.png)

Privacy Preference Center
-------------------------

When you visit any website, it may store or retrieve information on your browser, mostly in the form of cookies. This information might be about you, your preferences or your device and is mostly used to make the site work as you expect it to. The information does not usually directly identify you, but it can give you a more personalized web experience. Because we respect your right to privacy, you can choose not to allow some types of cookies. Click on the different category headings to find out more and change our default settings. However, blocking some types of cookies may impact your experience of the site and the services we are able to offer.
  
[More information](https://www.getdbt.com/cloud/privacy-policy/)

Allow All

### Manage Consent Preferences

#### Strictly Necessary Cookies

Always Active

Strictly necessary cookies are necessary for the site to function properly and cannot be switched off in our systems. These cookies are usually only set in response to actions made by you that amount to a request for services, such as setting your privacy preferences, logging in, or filling in forms. You can set your browser to block or alert you about these cookies, but blocking these cookies will prevent the site from functioning properly. These cookies typically do not store personal data.

#### Performance Cookies

Always Active

Performance cookies allow us to count visits and traffic sources so we can measure and improve the performance of our sites. These cookies help us understand how our sites are being used, such as which sites are the most and least popular and how people navigate around the sites. The information collected in these cookies are aggregated, meaning that the do not relate to you personally. Opting out of these cookies will prevent us from knowing when you have visited our site and will prevent us from monitoring site performance. In some cases, these cookies may be sent to our third party service providers to help us manage these analytics.

#### Targeting Cookies

Always Active

Targeting cookies may be set through our site by our advertising partners. They may be used by those companies to build a profile of your interests and show you relevant advertisements on other sites. These cookies do not store directly personal information, but are based on uniquely identifying your browser and device. If you do not allow these cookies, you will experience less targeted advertising.

#### Functional Cookies

Always Active

Functional cookies enable our sites to provide enhanced functionality and personalization. They may be set by us or by third party service providers whose services we have added to our sites. If you reject these cookies, then some or all of these services may not function properly.

Back Button

### Cookie List

Search Icon

Filter Icon

Clear

checkbox label label

Apply Cancel

Consent Leg.Interest

checkbox label label

checkbox label label

checkbox label label

Confirm My Choices

[![Powered by Onetrust](https://cdn.cookielaw.org/logos/static/powered_by_logo.svg "Powered by OneTrust Opens in a new Tab")](https://www.onetrust.com/products/cookie-consent/)