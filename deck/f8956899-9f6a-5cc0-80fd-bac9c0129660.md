---
tags:
  - jinja-macros
  - seeds
  - compiled-code
citations:
- cleaned_docs/jinja-macros/rank_3.md
guid: 42285dba5d
source: llm
uuid: f8956899-9f6a-5cc0-80fd-bac9c0129660
---

<front>

You need to pivot a 'payment_method' column into separate columns (one per method), but the payment methods may change over time. How can you automate this in a dbt model?

</front>

---

<back>

Use `run_query` to select distinct payment methods from the source table, then use a Jinja loop to generate the `CASE WHEN` statements dynamically.

Example:
```sql
{% set methods = run_query('select distinct method from ' ~ ref('payments')) %}
select
  id,
  {% for row in methods %}
    sum(case when method = '{{ row[0] }}' then amount end) as {{ row[0] }}_amount,
  {% endfor %}
from ...
```

</back>
